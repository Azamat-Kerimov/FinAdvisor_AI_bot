# Правила проекта FinAdvisor (обязательны к соблюдению)

## Инструкции для пользователя (обязательно для AI)

- Давать пользователю **чёткие пошаговые инструкции** из текущей точки, **без «если»** и без пропусков.
- Каждый шаг явно указывать: **где** выполнять (локальный ПК или VPS) и **что** ввести.
- Формат: подпись контекста + команда в блоке кода, например:
  - **CMD (локальный):** затем блок с командой для Windows **CMD** (не PowerShell).
  - **CMD (VPS):** затем блок с командой для SSH на сервере.
- На локальном ПК в инструкциях всегда использовать **CMD**, не PowerShell.
- Не заменять конкретные команды на «затем сделайте pull» — писать полную команду (git pull, путь, scp с нужным хостом и т.д.).

## Рабочий цикл разработки

1. **Cursor вносит изменения** в проект (локально).
2. **Пользователь коммитит или отклоняет** изменения (git add/commit или отмена).
3. **Локальная проверка:** открыть тестового бота и тестовый сайт на локальном компьютере; убедиться, что всё работает.
4. **Если результат устраивает** — Push в GitHub (с локального ПК).
5. **На VPS:** Pull из GitHub (или fetch + reset), перезапуск сервисов.
6. **Фронт на VPS:** на этом сервере фронт не собирается из‑за нехватки RAM — собирается локально, затем заливается на VPS (см. раздел «Фронт» ниже).

Полные команды по шагам — в разделе «Предпочтительные команды на VPS» и в deploy/README.md (обновление кода, заливка frontend/dist).

## Источник истины

- Репозиторий — единственный источник истины.
- GitHub всегда содержит актуальное состояние (master/main).
- Локальные файлы на VPS **никогда** не должны перезаписывать состояние из GitHub.

## Поток деплоя

**Строго:** Cursor (локально) → Push в GitHub → на VPS только `git pull`/reset → перезапуск systemd.

1. Разработка и коммиты — только локально (Cursor).
2. Push — в GitHub.
3. На VPS — только получение кода из GitHub и перезапуск сервисов.

## Строгие правила Git

1. **Никогда** не предлагать коммитить, стэшить или сохранять локальные изменения на VPS.
2. **Никогда** не предлагать решать конфликты путём сохранения локальных файлов на VPS.
3. Если на VPS git сообщает о локальных изменениях — **всегда** рекомендовать:
   - отменить локальные изменения;
   - привести репозиторий в точное состояние GitHub.
4. **Никогда** не предлагать править файлы напрямую на VPS.
5. VPS — только цель деплоя, **не** среда разработки.

## Файл .env

- **Единственный** файл, который может отличаться на VPS — `.env`.
- `.env` **никогда** не коммитить.
- Все остальные файлы на VPS должны **точно** совпадать с GitHub.

## Фронтенд

- На текущем VPS (мало RAM) фронт **не** собирается на сервере — сборка только на локальном ПК, затем заливка `frontend/dist` на VPS через `scp`.
- `frontend/dist` **не** коммитить.
- **Обновление фронта на VPS после изменений:**
  1. Локально: собрать фронт (см. deploy/README.md, вариант Б).
  2. Локально: залить dist на VPS: `scp -r frontend/dist root@109.70.24.22:~/FinAdvisor_AI_bot/frontend/`
  3. На VPS: `sudo systemctl restart finadvisor-api`

## Предпочтительные команды на VPS

После подключения к VPS для обновления кода:

```bash
git fetch
git reset --hard origin/main
git clean -fd -e .env -e venv
```

После pull/reset — только перезапуск systemd-сервисов.

- **Никогда** не переинициализировать git-репозиторий.
- **Никогда** не предлагать удалять каталог репозитория.

## Systemd

- Сервисы systemd должны запускаться с **абсолютными путями**.
- Не полагаться на активацию venv в shell.
- Использовать напрямую: `/root/FinAdvisor_AI_bot/venv/bin/python`.

## Цель

- Нулевые ручные правки на VPS.
- Нулевые конфликты слияния на VPS.
- Нулевые ошибки вида «local changes would be overwritten».

**Если инструкция нарушает эти правила — не предлагать её.**

- **Прод (VPS):** всегда использовать IP **109.70.24.22** в командах (scp, в документации).

---

## Шпаргалка: запуск API и бота для тестирования (локально)

Использовать **CMD** (два окна: одно для API, одно для бота). В корне проекта должен быть файл `.env` с тестовыми данными (BOT_TOKEN, WEB_APP_URL — для Mini App в Telegram нужен доступный извне URL, например через ngrok на порт 8000).

**Версия Python:** для локальной разработки нужен **Python 3.10, 3.11 или 3.12**. Python 3.13/3.14 на Windows могут требовать сборку pydantic-core из исходников (Rust) и давать ошибки. На VPS используется 3.10.

**Один раз: создать venv и установить зависимости**

CMD (локальный), из корня репозитория. Проверьте доступные версии: `py -0`. Создайте venv одной из поддерживаемых: 3.10, 3.11 или 3.12 (например 3.11):

```cmd
cd /d "c:\Users\Azama_mdmsx1j\OneDrive\Desktop\Бизнесы\1. Проекты ИИ-агентов\Финансовый консультант\репозиторий GitHub\FinAdvisor_AI_bot"
rmdir /s /q venv
py -3.11 -m venv venv
venv\Scripts\pip install -r requirements.txt
```

Если установлен только 3.10 или 3.12 — замените `py -3.11` на `py -3.10` или `py -3.12`.

**Окно 1 — API (тестовый сайт)**

CMD (локальный), из корня репозитория:

```cmd
cd /d "c:\Users\Azama_mdmsx1j\OneDrive\Desktop\Бизнесы\1. Проекты ИИ-агентов\Финансовый консультант\репозиторий GitHub\FinAdvisor_AI_bot"
venv\Scripts\activate
python -m uvicorn api:app --reload --host 0.0.0.0 --port 8000
```

Сайт будет доступен в браузере: **http://localhost:8000**

**Окно 2 — бот (тестовый бот в Telegram)**

CMD (локальный), из корня репозитория:

```cmd
cd /d "c:\Users\Azama_mdmsx1j\OneDrive\Desktop\Бизнесы\1. Проекты ИИ-агентов\Финансовый консультант\репозиторий GitHub\FinAdvisor_AI_bot"
venv\Scripts\activate
python bot.py
```

В `.env` для теста укажите тестовый **BOT_TOKEN** и **WEB_APP_URL**. Чтобы Mini App из Telegram открывал локальный фронт, поднимите туннель (например ngrok) на порт 8000 и в WEB_APP_URL укажите выданный ngrok URL.

**Тестовая среда (APP_ENV=test):** в `.env` задайте `APP_ENV=test`. Тогда: (1) на сайте сверху будет баннер «Тестовая среда | БД: … @ …» — видно, к какой БД подключены API и фронт; (2) бот при старте выведет в консоль «БД: … @ …» и «Режим: ТЕСТ»; (3) открывать сайт можно без Telegram — запросы идут с заголовком `X-Test-User-Id` (по умолчанию 1, можно задать в localStorage ключ `finadvisor_test_user_id`). Для теста лучше использовать отдельную БД (например `DB_NAME=FinAdvisor_test`), чтобы не путать с продом.

---

## Шпаргалка: обновление после изменений (по шагам)

**Шаг 1 — Локально: собрать фронт**

CMD (локальный), из корня репозитория:

```cmd
cd frontend
npm install
npm run build
cd ..
```

**Шаг 2 — Локально: Push в GitHub** (после коммита)

CMD (локальный):

```cmd
git add .
git commit -m "Ваше сообщение"
git push origin main
```

**Шаг 3 — VPS: подтянуть код и перезапустить бэкенд**

CMD (VPS), по SSH на сервер:

```bash
cd /root/FinAdvisor_AI_bot
git fetch
git reset --hard origin/main
git clean -fd -e .env -e venv
sudo systemctl restart finadvisor-api finadvisorbot
```

**Шаг 4 — Локально: залить собранный фронт на VPS**

CMD (локальный), из корня репозитория (где есть папка `frontend`):

```cmd
scp -r frontend/dist root@109.70.24.22:~/FinAdvisor_AI_bot/frontend/
```

**Шаг 5 — VPS: перезапустить API после заливки dist**

CMD (VPS):

```bash
sudo systemctl restart finadvisor-api
```
