# Устранение проблем с API сервером

## Проблема: Сервис не запускается (exit-code)

### Шаг 1: Проверьте логи

```bash
sudo journalctl -u finadvisor-api.service -n 50
```

Это покажет точную ошибку, из-за которой сервис не запускается.

### Возможные причины:

1. **Проблема с импортом bot.py**
   - При импорте `bot.py` создаются `Bot` и `Dispatcher`, что может вызвать ошибки
   - Решение: Используется ленивый импорт в `get_consultation`

2. **Отсутствуют переменные окружения**
   - Проверьте, что `.env` файл существует и содержит все необходимые переменные
   - Убедитесь, что `EnvironmentFile=/root/FinAdvisor_AI_bot/.env` указан в service файле

3. **Проблемы с путями**
   - Проверьте, что все пути в service файле правильные
   - Убедитесь, что виртуальное окружение существует: `/root/FinAdvisor_AI_bot/venv/bin/uvicorn`

4. **Порт 8000 занят**
   - Проверьте: `sudo netstat -tulpn | grep 8000`
   - Если занят, измените порт в service файле

### Шаг 2: Проверьте вручную

```bash
# Перейдите в директорию проекта
cd /root/FinAdvisor_AI_bot

# Активируйте виртуальное окружение
source venv/bin/activate

# Попробуйте запустить вручную
uvicorn api:app --host 0.0.0.0 --port 8000
```

Если есть ошибки, они будут видны в консоли.

### Шаг 3: Проверьте зависимости

```bash
# Убедитесь, что все зависимости установлены
pip install -r requirements.txt
```

### Шаг 4: Проверьте права доступа

```bash
# Убедитесь, что файлы доступны
ls -la /root/FinAdvisor_AI_bot/api.py
ls -la /root/FinAdvisor_AI_bot/.env
```

### Шаг 5: Альтернативное решение

Если проблема с импортом bot.py, можно временно отключить консультацию:

В `api.py` замените функцию `get_consultation`:

```python
@app.get("/api/consultation")
async def get_consultation(user_id: int = Depends(get_user_id)):
    """Получить AI консультацию"""
    return {"consultation": "Консультация временно недоступна. Используйте бота для получения консультаций."}
```

Это позволит запустить API сервер без проблем с импортом bot.py.

### Частые ошибки:

1. **ModuleNotFoundError: No module named 'bot'**
   - Убедитесь, что `api.py` находится в той же директории, что и `bot.py`

2. **NameError: name 'BOT_TOKEN' is not defined**
   - Проверьте, что `.env` файл содержит `BOT_TOKEN`

3. **Connection refused**
   - Проверьте, что база данных доступна
   - Проверьте настройки подключения в `.env`
